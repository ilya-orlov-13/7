@model IEnumerable<TyreServiceApp.Models.Car>

@{
    ViewData["Title"] = "Автомобили";
}

<style>
    :root {
        --button_radius: 0.75em;
        --button_outline_color: #000000;
        --button_color: #e8e8e8;
    }

    .main-3d-wrapper {
        position: relative;
        background: var(--button_outline_color);
        border-radius: var(--button_radius);
        display: block;
        margin-top: 0rem;
        cursor: default;
    }

    .main-3d-inner {
        display: block;
        box-sizing: border-box;
        border: 2px solid var(--button_outline_color);
        border-radius: var(--button_radius);
        background: white;
        padding: 20px;
        transform: translateY(-0.15em);
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
/* 
    .main-3d-wrapper:hover .main-3d-inner {
        transform: translateY(-0.35em);
    } */

    .uiverse-table {
        width: 100%;
        background: white;
        border: 1px solid rgb(203, 203, 203);
        border-radius: 8px;
        overflow: hidden;
        display: block;
        margin-top: 15px;
    }

    .uiverse-table__header {
        display: flex;
        background: rgb(60, 60, 60);
        color: white;
        border-bottom: 1px solid rgb(203, 203, 203);
    }

    .uiverse-table__row {
        display: flex;
        border-bottom: 1px solid rgb(203, 203, 203);
        background: white;
    }

    .uiverse-table__row:nth-child(even) {
        background: rgb(234, 235, 234);
    }

    .uiverse-table__row:last-child {
        border-bottom: none;
    }

    .uiverse-table__cell {
        padding: 12px;
        display: flex;
        align-items: center;
        min-height: 70px;
    }

    /* Настройка ширины колонок для Автомобилей */
    .col-photo { width: 10%; justify-content: center; border-right: 1px solid rgb(203, 203, 203); }
    .col-car-info { width: 25%; border-right: 1px solid rgb(203, 203, 203); }
    .col-ids { width: 25%; border-right: 1px solid rgb(203, 203, 203); }
    .col-client { width: 20%; border-right: 1px solid rgb(203, 203, 203); }
    .col-actions { width: 20%; justify-content: center; }

    .uiverse-table__header .uiverse-table__cell {
        font-weight: bold;
        font-size: 0.9rem;
        justify-content: center;
    }

    /* Внутренние стили контента */
    .car-main-info { display: flex; flex-direction: column; gap: 2px; }
    .car-title { font-weight: bold; font-size: 1rem; color: #212529; }
    .car-subtitle { font-size: 0.85rem; color: #6c757d; }
    
    .id-badge-container { display: flex; flex-direction: column; gap: 4px; }
    .vin-text { font-size: 0.75rem; font-family: monospace; color: #6c757d; }

    .car-photo-thumbnail {
        width: 65px;
        height: 45px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
        transition: transform 0.2s;
        cursor: pointer;
    }

    .car-photo-thumbnail:hover {
        transform: scale(1.1);
    }

    .client-link {
        text-decoration: none;
        color: #0d6efd;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .client-link:hover {
        text-decoration: underline;
    }

    /* Стили для фото контейнера */
    .photo-container {
        position: relative;
        display: inline-block;
    }

    .photo-count-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        border: 2px solid white;
    }

    /* Стили для кнопок навигации галереи */
    .gallery-nav-btn {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        background-color: #e5e7eb;
        border: 3px solid transparent;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0 8px;
        outline: none;
    }

    .gallery-nav-btn:hover {
        transform: translateY(-2px);
        background-color: #d1d5db;
    }

    .gallery-nav-btn:active {
        transform: translateY(2px);
    }

    .gallery-nav-btn:focus {
        border-color: transparent;
        outline: none;
    }

    .gallery-nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none !important;
    }

    .gallery-nav-btn.prev {
        transform: rotate(180deg);
    }

    .gallery-nav-btn.prev:hover {
        transform: rotate(180deg) translateY(-2px);
    }

    .gallery-nav-btn.prev:active {
        transform: rotate(180deg) translateY(2px);
    }

    .gallery-nav-btn i {
        font-size: 16px;
        color: #4b5563;
        transition: transform 0.2s ease;
    }

    .photo-counter-text {
        color: #6b7280;
        font-weight: 500;
        font-size: 14px;
        padding: 8px 16px;
        background-color: rgba(229, 231, 235, 0.8);
        border-radius: 20px;
        border: 1px solid rgba(209, 213, 219, 0.5);
        backdrop-filter: blur(4px);
    }

    /* Стили для модального окна галереи */
    .modal-gallery {
        background: transparent;
        border: none;
        border-radius: 0;
        overflow: hidden;
    }

    .modal-gallery .modal-header {
        display: none;
    }

    .modal-gallery .modal-title {
        display: none;
    }

    .modal-gallery .modal-body {
        background: transparent;
        position: relative;
        padding: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .gallery-slide {
        position: relative;
        width: 80vw;
        height: 80vh;
        max-width: 1000px;
        max-height: 700px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        background: #000;
    }

    .gallery-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.6s ease-in-out;
    }

    .modal-gallery .modal-footer {
        background: transparent;
        border: none;
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
    }

    .modal-backdrop {
        backdrop-filter: blur(10px);
        background-color: rgba(0, 0, 0, 0.8) !important;
    }

    html.modal-open, 
    body.modal-open {
        overflow: hidden !important;
        height: 100vh !important;
    }

    body.modal-open {
        padding-right: 0px !important;
    }

    /* Адаптивность для кнопок */
    @@media (max-width: 768px) {
        .gallery-nav-btn {
            display: none !important;
        }
        
        .photo-counter-text {
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .modal-gallery .modal-footer {
            padding: 16px;
            bottom: 30px;
        }

        .gallery-slide {
            width: 95vw;
            height: 85vh;
        }
    }

    @@media (min-width: 769px) {
        .gallery-nav-btn {
            width: 40px;
            height: 40px;
            margin: 0 8px;
        }
    }

    @@media (min-width: 993px) {
        .uiverse-table__header { 
            display: flex !important; 
        }
        .uiverse-table__row { 
            display: flex !important; 
        }
        .col-photo { width: 10%; }
        .col-car-info { width: 25%; }
        .col-ids { width: 25%; }
        .col-client { width: 20%; }
        .col-actions { width: 20%; }
    }

    @@media (max-width: 992px) {
        .uiverse-table__header { 
            display: none !important; 
        }
        .uiverse-table__row { 
            flex-direction: column !important; 
            padding: 10px 0; 
            border-bottom: 1px solid rgb(203, 203, 203) !important; 
        }
        .col-photo, .col-car-info, .col-ids, .col-client, .col-actions { 
            width: 100% !important; 
            border-right: none !important; 
            border-bottom: 1px solid rgba(203, 203, 203, 0.5); 
            justify-content: flex-start !important; 
        }
        .uiverse-table__cell { 
            min-height: auto !important; 
            padding: 8px 15px !important; 
        }
        .col-actions { 
            border-bottom: none; 
        }
        
        .col-photo::before { content: "Фото: "; font-weight: bold; margin-right: 10px; }
        .col-car-info::before { content: "Автомобиль: "; font-weight: bold; margin-right: 10px; }
        .col-ids::before { content: "Идентификаторы: "; font-weight: bold; margin-right: 10px; }
        .col-client::before { content: "Владелец: "; font-weight: bold; margin-right: 10px; }
        .col-actions::before { content: "Действия: "; font-weight: bold; margin-right: 10px; }
    }
</style>

<div class="container-fluid pt-2 pb-4">
    <div class="main-3d-wrapper">
        <div class="main-3d-inner">
            
            <!-- Заголовок и кнопка -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">
                    <i class="bi bi-car-front-fill me-2"></i> Список автомобилей
                </h3>
                <a asp-action="Create" class="btn btn-dark">
                    <i class="bi bi-plus-circle me-1"></i> Добавить автомобиль
                </a>
            </div>

            @if (Model.Any())
            {
                <div class="uiverse-table">
                    <!-- Заголовок таблицы -->
                    <div class="uiverse-table__header">
                        <div class="uiverse-table__cell col-photo">Фото</div>
                        <div class="uiverse-table__cell col-car-info">Автомобиль</div>
                        <div class="uiverse-table__cell col-ids">Идентификаторы</div>
                        <div class="uiverse-table__cell col-client">Владелец</div>
                        <div class="uiverse-table__cell col-actions">Действия</div>
                    </div>
                    
                    <!-- Строки данных -->
                    @foreach (var item in Model)
                    {
                        <div class="uiverse-table__row">
                            <!-- Фото -->
                            <div class="uiverse-table__cell col-photo">
                                @{
                                    var allCarPhotos = new List<string>();
                                    if (!string.IsNullOrEmpty(item.PhotoPath))
                                    {
                                        allCarPhotos.Add(item.PhotoPath);
                                    }
                                    if (!string.IsNullOrEmpty(item.AdditionalPhotos))
                                    {
                                        try
                                        {
                                            var additionalPhotos = System.Text.Json.JsonSerializer.Deserialize<List<string>>(item.AdditionalPhotos);
                                            if (additionalPhotos != null)
                                            {
                                                allCarPhotos.AddRange(additionalPhotos);
                                            }
                                        }
                                        catch
                                        {
                                        }
                                    }
                                }
                                
                                @if (allCarPhotos.Count > 0)
                                {
                                    <div class="photo-container">
                                        <img src="@allCarPhotos[0]" 
                                             class="car-photo-thumbnail" 
                                             alt="Car"
                                             data-bs-toggle="modal" 
                                             data-bs-target="#photoModal"
                                             data-car-id="@item.CarId"
                                             data-car-info="@item.Brand @item.Model (@item.LicensePlate)" />
                                        
                                        <!-- Скрытый элемент с данными фото -->
                                        <script type="application/json" class="car-photos-data" data-car-id="@item.CarId">
                                            @Html.Raw(Json.Serialize(allCarPhotos))
                                        </script>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-muted"><i class="bi bi-camera fs-4"></i></div>
                                }
                            </div>

                            <!-- Марка, Модель, Год -->
                            <div class="uiverse-table__cell col-car-info">
                                <div class="car-main-info">
                                    <div class="car-title">@item.Brand @item.Model</div>
                                    <div class="car-subtitle">Год выпуска: @item.ManufactureYear</div>
                                </div>
                            </div>

                            <!-- Номер и VIN -->
                            <div class="uiverse-table__cell col-ids">
                                <div class="id-badge-container">
                                    <div><span class="badge bg-secondary">@item.LicensePlate</span></div>
                                    <div class="vin-text">VIN: @item.Vin</div>
                                </div>
                            </div>

                            <!-- Клиент -->
                            <div class="uiverse-table__cell col-client">
                                @if (item.Client != null)
                                {
                                    <a asp-controller="Clients" asp-action="Details" asp-route-id="@item.ClientId" class="client-link">
                                        <i class="bi bi-person me-1"></i>@item.Client.FullName
                                    </a>
                                }
                                else
                                {
                                    <span class="text-muted small">Не указан</span>
                                }
                            </div>

                            <!-- Действия -->
                            <div class="uiverse-table__cell col-actions">
                                <div class="d-flex justify-content-center gap-2 w-100">
                                    <a asp-action="Details" asp-route-id="@item.CarId" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@item.CarId" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@item.CarId" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5 border rounded bg-light">
                    <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">Автомобили не найдены</h4>
                    <p class="text-muted">Добавьте первый автомобиль, чтобы начать работу.</p>
                </div>
            }
</div>

<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content modal-gallery">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="photoModalLabel">
                    <i class="bi bi-images me-2"></i>Галерея автомобиля
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="gallery-slide">
                    <img id="modalPhoto" src="" alt="Car Photo" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="gallery-nav-btn prev" id="prevPhotoBtn">
                    <i class="bi bi-arrow-right"></i>
                </button>
                <span id="photoCounter" class="photo-counter-text"></span>
                <button type="button" class="gallery-nav-btn" id="nextPhotoBtn">
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Инициализация тултипов Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // 2. Переменные для галереи
            let currentPhotos = [];
            let currentPhotoIndex = 0;
            
            const photoModal = document.getElementById('photoModal');
            const modalPhoto = document.getElementById('modalPhoto');
            const photoCounter = document.getElementById('photoCounter');
            const prevBtn = document.getElementById('prevPhotoBtn');
            const nextBtn = document.getElementById('nextPhotoBtn');

            photoModal.addEventListener('show.bs.modal', function (event) {
                const scrollY = window.scrollY;
                
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollY}px`;
                document.body.style.width = '100%';
                document.body.style.overflow = 'hidden';
                
                document.documentElement.style.overflow = 'hidden';
                document.documentElement.style.height = '100%';
                
                document.body.classList.add('modal-open');
                document.documentElement.classList.add('modal-open');

                const button = event.relatedTarget;
                const carId = button.getAttribute('data-car-id');
                
                modalPhoto.src = '';
                
                // Поиск данных о фото
                const photoDataElement = document.querySelector(`.car-photos-data[data-car-id="${carId}"]`);
                
                if (photoDataElement) {
                    try {
                        currentPhotos = JSON.parse(photoDataElement.textContent.trim());
                    } catch (e) {
                        console.error('Ошибка парсинга фото:', e);
                        currentPhotos = [];
                    }
                }
                
                currentPhotoIndex = 0;
                showCurrentPhoto();
            });

            photoModal.addEventListener('hidden.bs.modal', function () {
                const scrollY = document.body.style.top;
                
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                document.documentElement.style.height = '';
                
                document.body.classList.remove('modal-open');
                document.documentElement.classList.remove('modal-open');
                
                if (scrollY) {
                    window.scrollTo(0, parseInt(scrollY || '0') * -1);
                }
                
                modalPhoto.src = '';
                currentPhotos = [];
            });

            function showCurrentPhoto() {
                if (currentPhotos.length === 0) return;
                
                modalPhoto.style.opacity = '0.5';
                
                const img = new Image();
                img.onload = function() {
                    modalPhoto.src = currentPhotos[currentPhotoIndex];
                    modalPhoto.style.opacity = '1';
                };
                img.src = currentPhotos[currentPhotoIndex];
                
                // Обновление счетчика
                photoCounter.textContent = `${currentPhotoIndex + 1} из ${currentPhotos.length}`;
                
                // Скрытие управления, если фото одно
                if (currentPhotos.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                    photoCounter.style.display = 'none';
                } else {
                    const isMobile = window.innerWidth <= 768;
                    prevBtn.style.display = isMobile ? 'none' : 'inline-flex';
                    nextBtn.style.display = isMobile ? 'none' : 'inline-flex';
                    photoCounter.style.display = 'inline-block';
                }
            }

            function nextPhoto() {
                currentPhotoIndex = (currentPhotoIndex + 1) % currentPhotos.length;
                showCurrentPhoto();
            }

            function prevPhoto() {
                currentPhotoIndex = (currentPhotoIndex - 1 + currentPhotos.length) % currentPhotos.length;
                showCurrentPhoto();
            }

            prevBtn.addEventListener('click', prevPhoto);
            nextBtn.addEventListener('click', nextPhoto);

            photoModal.addEventListener('keydown', function(e) {
                if (currentPhotos.length <= 1) return;
                if (e.key === 'ArrowLeft') prevPhoto();
                if (e.key === 'ArrowRight') nextPhoto();
            });

            photoModal.addEventListener('shown.bs.modal', function() {
                photoModal.focus();
            });

            let touchStartX = 0;
            let touchEndX = 0;

            photoModal.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            photoModal.addEventListener('touchend', e => {
                if (currentPhotos.length <= 1) return;
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const swipeDistance = touchEndX - touchStartX;
                if (Math.abs(swipeDistance) > 50) {
                    if (swipeDistance > 0) prevPhoto();
                    else nextPhoto();
                }
            }
        });
    </script>
}